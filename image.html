<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WeMear AR - Image Tracking</title>

    <!-- MindAR & A-Frame Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        font-family: Arial, sans-serif;
        flex-direction: column;
      }

      .loading-overlay.hidden {
        display: none;
      }

      .loading-text {
        font-size: 18px;
        margin-bottom: 20px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top-color: #00ff88;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .error-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 0, 0, 0.9);
        color: white;
        padding: 15px 30px;
        border-radius: 10px;
        z-index: 10000;
        font-family: Arial, sans-serif;
        max-width: 80%;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
      <div class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° AR...</div>
      <div class="spinner"></div>
    </div>

    <script type="module">
      import { renderImageTracking } from "./src/image_tracking.js";

      /**
       * ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà renderImageTracking ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
       */
      function convertToRenderFormat(imageData) {
        const targets = {};
        const mindFile = imageData.mindFile.mind_src;

        // ‡πÅ‡∏õ‡∏•‡∏á tracks ‚Üí scenes ‚Üí assets ‡πÄ‡∏õ‡πá‡∏ô targets object
        imageData.tracks.forEach((track, trackIndex) => {
          const targetKey = `target${trackIndex}`;

          // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™ scene ‡πÅ‡∏£‡∏Å (S1)
          const firstScene = track.scenes.find(
            (scene) => scene.scene_id === "S1"
          );
          if (!firstScene) return;

          // ‡πÅ‡∏õ‡∏•‡∏á assets ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà renderImageTracking ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
          targets[targetKey] = firstScene.assets.map((asset) => ({
            src: asset.src,
            type: asset.type,
            scale: asset.scale,
            position: asset.position,
            rotation: asset.rotation,
            opacity: asset.opacity,
            loop: asset.loop,
            muted: asset.muted,
            autoplay: asset.autoplay,
            action: asset.action,
          }));
        });

        return { targets, mindFile };
      }

      /**
       * ‡πÅ‡∏™‡∏î‡∏á error message
       */
      function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.innerText = message;
        document.body.appendChild(errorDiv);

        setTimeout(() => {
          errorDiv.remove();
        }, 5000);
      }

      /**
       * Main initialization
       */
      async function init() {
        try {
          // 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å localStorage
          const projectDataStr = localStorage.getItem("projectData");

          if (!projectDataStr) {
            throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å");
          }

          const projectData = JSON.parse(projectDataStr);
          console.log("üì¶ Project Data:", projectData);

          // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• image tracking mode
          const imageData = projectData.info?.tracking_modes?.image;

          if (!imageData) {
            throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Image Tracking ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ô‡∏µ‡πâ");
          }

          console.log("üéØ Image Tracking Data:", imageData);

          // 3. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà renderImageTracking ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
          const { targets, mindFile } = convertToRenderFormat(imageData);

          console.log("‚úÖ Converted Targets:", targets);
          console.log("‚úÖ Mind File:", mindFile);

          // 4. ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå AR Scene
          await renderImageTracking({
            targets,
            mindFile,
            onReady: (scene) => {
              console.log("üöÄ AR Ready!");
              // ‡∏ã‡πà‡∏≠‡∏ô loading overlay
              const loadingOverlay = document.getElementById("loading-overlay");
              if (loadingOverlay) {
                loadingOverlay.classList.add("hidden");
              }
            },
          });
        } catch (error) {
          console.error("‚ùå Error initializing AR:", error);

          // ‡πÅ‡∏™‡∏î‡∏á error
          showError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);

          // ‡∏ã‡πà‡∏≠‡∏ô loading overlay
          const loadingOverlay = document.getElementById("loading-overlay");
          if (loadingOverlay) {
            loadingOverlay.classList.add("hidden");
          }

          // Redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
          setTimeout(() => {
            window.location.href = "/";
          }, 3000);
        }
      }

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
      init();
    </script>
  </body>
</html>
